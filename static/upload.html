<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Image Offering | KARMIC IDENTITY</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        * { -webkit-user-select: none; user-select: none; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
            --font-main: 'Shippori Mincho', serif;
            --rand-x: 50%;
            --rand-y: 50%;
        }

        /* ★動画を確実に見せるための設定 */
        html { background-color: #000; }
        body {
            background-color: transparent; 
            color: var(--text-color);
            font-family: var(--font-main); margin: 0; padding: 0;
            min-height: 100vh; display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden; transition: opacity 1.5s ease;
        }
        body.fade-out { opacity: 0; }

        .text-marbling {
            background-image: url('/static/texture.jpg'); background-size: 1000%;
            background-position: var(--rand-x) var(--rand-y);
            -webkit-background-clip: text; background-clip: text; color: transparent;
        }

        /* 背景動画 */
        #bg-video { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -2; }
        .video-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); z-index: -1; }

        .header-fixed {
            position: fixed; top: 0; left: 0; width: 100%; height: 80px;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px);
            z-index: 100; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 0 20px;
        }
        .header-title { font-size: 1.1rem; letter-spacing: 0.1em; font-weight: 500; margin: 0; }
        .header-right { display: flex; gap: 15px; align-items: center; justify-self: end; }

        .lang-switch-wrapper { display: flex; border: 1px solid #fff; border-radius: 20px; overflow: hidden; font-size: 0.7rem; cursor: pointer; }
        .lang-part { padding: 4px 14px; color: #fff; transition: color 0.3s; }
        .lang-part.active {
            background-image: url('/static/texture.jpg'); 
            background-size: 1000%; background-position: var(--rand-x) var(--rand-y);
            color: #000; font-weight: bold;
        }

        .container { width: 100%; max-width: 600px; padding: 20px; padding-top: 100px; padding-bottom: 120px; text-align: center; z-index: 1; }

        .btn-entry {
            position: relative; display: block; width: 100%; max-width: 280px; margin: 40px auto; padding: 22px;
            font-family: var(--font-main); font-size: 1.2rem; letter-spacing: 0.3em;
            background: transparent; color: #fff; border: 1px solid #fff; cursor: pointer; transition: transform 0.1s; z-index: 1;
        }
        .btn-entry:active, .btn-entry.clicked {
            border: 2px solid transparent; border-image: url('/static/texture.jpg') 30 stretch;
            background-image: url('/static/texture.jpg'); background-size: 1000%; background-position: var(--rand-x) var(--rand-y);
            -webkit-background-clip: text; background-clip: text; color: transparent;
            transform: scale(0.98);
        }
        .btn-entry:disabled { opacity: 0.5; cursor: not-allowed; border-color: #555; color: #555; }

        .preview-area {
            width: 100%; height: 300px; border: 1px solid #444; margin: 40px 0; display: flex; justify-content: center; align-items: center;
            overflow: hidden; background: rgba(255,255,255,0.05); position: relative;
        }
        .preview-img { max-width: 100%; max-height: 100%; display: none; }
        .placeholder-text { color: #666; font-size: 0.9rem; letter-spacing: 0.1em; }
        #file-input { display: none; }
        .desc-text { line-height: 2.2; color: #ccc; margin-bottom: 30px; font-size: 0.95rem; }

        #success-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 200; display: none;
            flex-direction: column; justify-content: center; align-items: center; animation: fadeIn 0.5s; text-align: center;
        }
        #success-overlay h2, #success-overlay p { text-align: center; width: 100%; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .hidden { display: none !important; }
        .lang-jp .lang-en { display: none; }
        .lang-en .lang-jp { display: none; }
    </style>
</head>
<body class="lang-jp">

    <video autoplay muted loop playsinline id="bg-video"><source src="/static/DAMN2.m4v" type="video/mp4"></video>
    <div class="video-overlay"></div>

    <div class="header-fixed">
        <div class="header-left"></div>
        <div class="header-center">
            <h1 class="header-title"><span class="text-marbling">Image Offering</span></h1>
        </div>
        <div class="header-right">
            <div class="lang-switch-wrapper" onclick="toggleLanguage()">
                <div id="lang-part-jp" class="lang-part active">JP</div>
                <div id="lang-part-en" class="lang-part">EN</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="desc-text">
            <span class="lang-jp">
                あなたの端末にある画像を<br>「量子庵」へ奉納します。<br>この画像はKarma Portrait生成の<br>重要な核となります。
            </span>
            <span class="lang-en">
                Offer an image from your device<br>to the "Ryoshi-an".<br>This image will become the core<br>of your Karma Portrait generation.
            </span>
        </div>

        <div class="preview-area" onclick="document.getElementById('file-input').click()">
            <span class="placeholder-text lang-jp" id="ph-jp">タップして画像を選択</span>
            <span class="placeholder-text lang-en" id="ph-en">Tap to select image</span>
            <img id="preview" class="preview-img">
        </div>
        
        <input type="file" id="file-input" accept="image/*" onchange="handleFileSelect(event)">

        <button id="submit-btn" class="btn-entry" onclick="uploadImage()" disabled>Submit</button>
        
        <div style="margin-top:60px; font-size:0.7rem; color:#444;">© GOKURAKU FINE ARTS</div>
    </div>

    <div id="success-overlay">
        <h2 class="text-marbling" style="font-size:1.5rem; letter-spacing:0.2em; margin-bottom:30px;">
            <span class="lang-jp">奉納完了</span><span class="lang-en">Done</span>
        </h2>
        <p style="color:#ccc; line-height:2;">
            <span class="lang-jp">画像が転送されました。<br>5秒後に解説ページへ移動します。</span>
            <span class="lang-en">Image transferred.<br>Redirecting to info page in 5s.</span>
        </p>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session_id');
        let currentLang = urlParams.get('lang') || 'jp';

        document.addEventListener('DOMContentLoaded', () => {
            setLanguage(currentLang);
            initMarbling();
        });

        function initMarbling() {
            const rX = Math.floor(Math.random() * 100) + '%';
            const rY = Math.floor(Math.random() * 100) + '%';
            document.documentElement.style.setProperty('--rand-x', rX);
            document.documentElement.style.setProperty('--rand-y', rY);
        }

        function toggleLanguage() {
            setLanguage(currentLang === 'jp' ? 'en' : 'jp');
        }

        function setLanguage(lang) {
            currentLang = lang;
            document.body.className = 'lang-' + lang;
            document.getElementById('lang-part-jp').classList.toggle('active', lang === 'jp');
            document.getElementById('lang-part-en').classList.toggle('active', lang === 'en');
            initMarbling();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.getElementById('preview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    document.getElementById('ph-jp').style.display = 'none';
                    document.getElementById('ph-en').style.display = 'none';
                    document.getElementById('submit-btn').disabled = false;
                }
                reader.readAsDataURL(file);
            }
        }

        async function uploadImage() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            if (!file || !sessionId) return;

            const btn = document.getElementById('submit-btn');
            btn.classList.add('clicked');
            btn.innerText = (currentLang === 'jp') ? "送信中..." : "Sending...";

            const formData = new FormData();
            formData.append('session_id', sessionId);
            formData.append('image', file);

            try {
                const res = await fetch('/upload-satellite', { method: 'POST', body: formData });
                
                if (res.ok) {
                    setTimeout(() => {
                        document.getElementById('success-overlay').style.display = 'flex';
                        setTimeout(() => {
                            document.body.classList.add('fade-out');
                            setTimeout(() => {
                                window.location.href = `/static/info.html?lang=${currentLang}`;
                            }, 1500); 
                        }, 5000);
                    }, 500);
                } else {
                    alert("Upload failed.");
                    btn.classList.remove('clicked');
                    btn.innerText = "Submit";
                }
            } catch (e) {
                alert("Error: " + e);
                btn.classList.remove('clicked');
                btn.innerText = "Submit";
            }
        }
    </script>
</body>
</html>